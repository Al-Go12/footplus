{% extends 'user/base.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

{% csrf_token %}

    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Your Cart
                </div>
            </div>
        </div>
        {% if not cart_items %}
        <div id="inside-div">
            <h2 class="text-center">Your Shopping Cart is Empty</h2>
            <br>
            <div class="text-center">
                <a href="{% url 'base:index' %}" class="btn btn-primary">Continue Shopping</a>
            </div>
        </div>
    {% else %}
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table shopping-summery text-center clean">
                                <thead>
                                    <tr class="main-heading">
                                        <th scope="col">Image</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Price</th>
                                        <th scope="col">Quantity</th>
                                        <th scope="col">Subtotal</th>
                                        <th scope="col">Remove</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        {% for cart_item in cart_items %}
                                        <td class="image product-thumbnail"><img src="{{ cart_item.variations.image.url }}" alt="#"></td>
                                        <td class="product-des product-name">
                                            <h5 class="product-name"><a href="">{{ cart_item.product.product_name }}</a></h5>
                                            <p class="font-xs">Colour:{{ cart_item.variations.color }}<br> Size:{{ cart_item.variations.size }}
                                            </p>
                                            </p>
                                        </td>
                                        <td class="price" data-title="Price"><span>{{ cart_item.variations.price }} </span></td>
                                        <td class="text-center" data-title="Stock">
                                            <input type="hidden" value="{{ cart_item.product.product_id }}" class="product_id">
                                    <input type="hidden" value="{{ forloop.counter }}" class="item_counter">
                                    <input type="hidden" value="{{ cart_item.id }}" class="cart_id">
                                    <div class="input-group input-spinner">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-primary button-minus" type="button">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="text" class="form-control txt-center qty" style="width: 35%; height: 30px; background-color: #f8f9fa; border-color: #ced4da;" value="{{ cart_item.quantity }}" readonly>
                                        <div class="input-group-append">
                                            <button class="btn btn-primary button-plus" type="button">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                        </td>
                                        <td class="text-right" data-title="Cart">
                                            <span>&#x20B9;{{ cart_item.sub_total }} </span>
                                        </td>
                                        <td class="action" data-title="Remove"><a href="{% url 'cart:remove_cart_item' product_id=cart_item.product_id cart_item_id=cart_item.id %}" class="text-muted"><i class="fi-rs-trash"></i></a></td>
                                    </tr>
                                    {% endfor %}
                                    
                            </table>
                        </div>
                        <div class="cart-action text-end">
                            <a class="btn  mr-10 mb-sm-15"><i class="fi-rs-shuffle mr-10"></i>Update Cart</a>
                            <a class="btn "><i class="fi-rs-shopping-bag mr-10"></i>Continue Shopping</a>
                        </div>
                        <div class="divider center_icon mt-50 mb-50"><i class="fi-rs-fingerprint"></i></div>

                            <div class="col-lg-6 col-md-12">
                                <div class="border p-md-4 p-30 border-radius cart-totals">
                                    <div class="heading_s1 mb-3">
                                        <h4>Cart Totals</h4>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table">
                                            <tbody>
                                                <tr>
                                                    <td class="cart_total_label">Cart Subtotal</td>
                                                    <td class="cart_total_amount"><span class="font-lg fw-900 text-brand">{{ total }}</span></td>
                                                </tr>
                                                <tr>
                                                    <td class="cart_total_label">Tax + Shipping</td>
                                                    <td class="cart_total_amount"> <i class="ti-gift mr-5"></i> {{ tax }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="cart_total_label">Grand Total</td>
                                                    <td class="cart_total_amount"><strong><span class="font-xl fw-900 text-brand">{{ grand_total }}</span></strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <a href="{% url 'cart:checkout' %}" class="btn "> <i class="fi-rs-box-alt mr-10"></i> Proceed To CheckOut</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
    </main>


    <style>
        .input-group-prepend, .input-group-append {
            width: 200%; /* Adjust the width as needed */
        }
    
        .form-control {
            width: 100%; /* Adjust the width as needed */
            height: 30px;
            text-align: center;
        }
    
        .btn {
            width: 100%; /* Adjust the width as needed */
        }
    </style>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    
        <script>
    $(document).ready(function () {
        var token = $('input[name=csrfmiddlewaretoken]').val();
    
        // Handle button clicks
        $('.button-plus').click(function (e) {
            e.preventDefault();
            var $productRow = $(this).closest('.product_data');
    
            var productId = $productRow.find('.product_id').val();
            var itemCounter = parseInt($productRow.find('.item_counter').val(), 10);
            var cartItemId = $productRow.find('.cart_id').val();
            var qtyInput = $productRow.find('.qty');
            var subTotalField = $productRow.find('.sub_total');
    
            // Make an AJAX request to update the cart item quantity
            $.ajax({
                method: "POST",
                url: "{% url 'cart:newcart_update' %}",
                data: {
                    'product_id': productId,
                    'cart_id': cartItemId,
                    'qty': qtyInput.val(),
                    'counter': itemCounter,
                    'csrfmiddlewaretoken': token
                },
                success: function (response) {
                    if (response.status === "success") {
                        console.log('hai');
                        qtyInput.val(response.new_quantity);
                        subTotalField.html("₹" + response.sub_total);
                        $('.total').text("₹" + response.total);
                        $('.grand_total').text("₹" + response.grand_total);
                        $('.tax').text("₹" + response.tax);
                    } else if (response.status === "error") {
                        alert(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                }
            });
        });
    
        $('.button-minus').click(function (e) {
            e.preventDefault();
            var $productRow = $(this).closest('.product_data');
    
            var productId = $productRow.find('.product_id').val();
            var itemCounter = parseInt($productRow.find('.item_counter').val(), 10);
            var cartItemId = $productRow.find('.cart_id').val();
            var qtyInput = $productRow.find('.qty');
            var subTotalField = $productRow.find('.sub_total');
    
            // Make an AJAX request to remove the cart item
            $.ajax({
                method: "POST",
                url: "{% url 'cart:remove_cart_item_fully' %}",
                data: {
                    'product_id': productId,
                    'cart_id': cartItemId,
                    'qty': qtyInput.val(),
                    'counter': itemCounter,
                    'csrfmiddlewaretoken': token
                },
                success: function (response) {
                    if (response.status === "success") {
                        qtyInput.val(response.new_quantity);
                        subTotalField.html("₹" + response.sub_total);
                        $('.total').text("₹" + response.total);
                        $('.grand_total').text("₹" + response.grand_total);
                        $('.tax').text("₹" + response.tax);
                    } else {
                        location.reload();
                        alert(response.message);
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                }
            });
        });
    });
    
        </script>

    
{% endblock %}
    